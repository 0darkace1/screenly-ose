// Generated by CoffeeScript 1.4.0

/* screenly-ose ui
*/


(function() {
  var API, App, Asset, AssetRowView, Assets, AssetsView, EditAssetView, date_to, get_template, now, y2ts, years_from_now,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __slice = [].slice;

  API = (window.Screenly || (window.Screenly = {}));

  API.date_to = date_to = {
    iso: function(d) {
      return (new Date(d)).toISOString();
    },
    string: function(d) {
      return (moment(new Date(d))).format("MM/DD/YYYY hh:mm:ss A");
    },
    time: function(d) {
      return (new Date(d)).toLocaleTimeString();
    },
    timestamp: function(d) {
      return (new Date(d)).getTime();
    }
  };

  now = function() {
    return new Date();
  };

  y2ts = function(years) {
    return years * 365 * 24 * 60 * 60000;
  };

  years_from_now = function(years) {
    return new Date((y2ts(years)) + date_to.timestamp(now()));
  };

  get_template = function(name) {
    return _.template(($("#" + name + "-template")).html());
  };

  Backbone.emulateJSON = true;

  API.Asset = Asset = (function(_super) {

    __extends(Asset, _super);

    function Asset() {
      return Asset.__super__.constructor.apply(this, arguments);
    }

    Asset.prototype.idAttribute = "asset_id";

    return Asset;

  })(Backbone.Model);

  API.Assets = Assets = (function(_super) {

    __extends(Assets, _super);

    function Assets() {
      return Assets.__super__.constructor.apply(this, arguments);
    }

    Assets.prototype.url = "/api/assets";

    Assets.prototype.model = Asset;

    return Assets;

  })(Backbone.Collection);

  EditAssetView = (function(_super) {

    __extends(EditAssetView, _super);

    function EditAssetView() {
      this.changeMimetype = __bind(this.changeMimetype, this);

      this.submit = __bind(this.submit, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);

      this.$fv = __bind(this.$fv, this);

      this.$f = __bind(this.$f, this);
      return EditAssetView.__super__.constructor.apply(this, arguments);
    }

    EditAssetView.prototype.$f = function(field) {
      return this.$("[name='" + field + "']");
    };

    EditAssetView.prototype.$fv = function() {
      var field, val, _ref;
      field = arguments[0], val = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
      return (_ref = this.$f(field)).val.apply(_ref, val);
    };

    EditAssetView.prototype.initialize = function(options) {
      this.template = get_template('asset-modal');
      ($('body')).append(this.render().el);
      return (this.$el.children(":first")).modal();
    };

    EditAssetView.prototype.render = function() {
      var field, which, _i, _j, _len, _len1, _ref, _ref1;
      this.$el.html(this.template());
      (this.$("input.date")).datepicker({
        autoclose: true
      });
      (this.$('input.time')).timepicker({
        minuteStep: 5,
        defaultTime: 'current',
        showInputs: true,
        disableFocus: true,
        showMeridian: true
      });
      (this.$('#modalLabel')).text((this.model ? "Edit Asset" : "Add Asset"));
      if (this.model) {
        (this.$("form")).attr("action", this.model.url());
        _ref = 'name uri duration mimetype'.split(' ');
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          field = _ref[_i];
          this.$fv(field, this.model.get(field));
        }
        _ref1 = ['start', 'end'];
        for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
          which = _ref1[_j];
          (this.$f("" + which + "_date_date")).datepicker('update', this.model.get("" + which + "_date"));
          this.$fv("" + which + "_date_time", date_to.time(this.model.get("" + which + "_date")));
        }
      } else {
        (this.$("input.date")).datepicker('update', new Date());
      }
      this.changeMimetype();
      return this;
    };

    EditAssetView.prototype.events = {
      'click #submit-button': 'submit',
      'change select[name=mimetype]': 'changeMimetype'
    };

    EditAssetView.prototype.submit = function(e) {
      var which, _i, _len, _ref;
      _ref = ['start', 'end'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        which = _ref[_i];
        this.$fv("" + which + "_date", date_to.iso((this.$fv("" + which + "_date_date")) + " " + (this.$fv("" + which + "_date_time"))));
      }
      return (this.$("form")).submit();
    };

    EditAssetView.prototype.changeMimetype = function() {
      return (this.$('.file_upload')).toggle((this.$fv('mimetype')) !== 'webpage');
    };

    return EditAssetView;

  })(Backbone.View);

  AssetRowView = (function(_super) {

    __extends(AssetRowView, _super);

    function AssetRowView() {
      this["delete"] = __bind(this["delete"], this);

      this.edit = __bind(this.edit, this);

      this.toggleActive = __bind(this.toggleActive, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return AssetRowView.__super__.constructor.apply(this, arguments);
    }

    AssetRowView.prototype.tagName = "tr";

    AssetRowView.prototype.initialize = function(options) {
      return this.template = get_template('asset-row');
    };

    AssetRowView.prototype.render = function() {
      this.$el.html(this.template(this.model.toJSON()));
      (this.$(".toggle input")).prop("checked", this.model.get('is_active'));
      (this.$(".asset-icon")).addClass((function() {
        switch (this.model.get("mimetype")) {
          case "video":
            return "icon-facetime-video";
          case "image":
            return "icon-picture";
          case "webpage":
            return "icon-globe";
          default:
            return "";
        }
      }).call(this));
      (this.$("#delete-asset-button")).popover({
        html: true,
        placement: 'left',
        title: "Are you sure?",
        content: get_template('confirm-delete')
      });
      return this;
    };

    AssetRowView.prototype.events = {
      'click #activation-toggle': 'toggleActive',
      'click #edit-asset-button': 'edit',
      'click #confirm-delete': 'delete',
      'click #cancel-delete': 'hidePopover'
    };

    AssetRowView.prototype.toggleActive = function(e) {
      var _this = this;
      if (this.model.get('is_active')) {
        this.model.set({
          is_active: false,
          end_date: date_to.iso(now())
        });
      } else {
        this.model.set({
          is_active: true,
          start_date: date_to.iso(now()),
          end_date: date_to.iso(years_from_now(10))
        });
      }
      this.model.save();
      (this.$(".toggle input")).prop("checked", this.model.get('is_active'));
      setTimeout((function() {
        return _this.remove();
      }), 300);
      e.preventDefault();
      return false;
    };

    AssetRowView.prototype.edit = function(e) {
      new EditAssetView({
        model: this.model
      });
      return false;
    };

    AssetRowView.prototype["delete"] = function(e) {
      var _this = this;
      this.hidePopover();
      this.model.destroy().done(function() {
        return _this.remove();
      });
      return false;
    };

    AssetRowView.prototype.hidePopover = function() {
      return (this.$("#delete-asset-button")).popover('hide');
    };

    return AssetRowView;

  })(Backbone.View);

  AssetsView = (function(_super) {

    __extends(AssetsView, _super);

    function AssetsView() {
      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return AssetsView.__super__.constructor.apply(this, arguments);
    }

    AssetsView.prototype.initialize = function(options) {
      var event, _i, _len, _ref, _results,
        _this = this;
      this.collection.bind('change:is_active', function(model) {
        return setTimeout((function() {
          return _this.render(_([model]));
        }), 320);
      });
      _ref = ['reset', 'add'];
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        event = _ref[_i];
        _results.push(this.collection.bind(event, this.render));
      }
      return _results;
    };

    AssetsView.prototype.render = function(models) {
      var which, _i, _len, _ref,
        _this = this;
      if (models == null) {
        models = this.collection;
      }
      models.each(function(model) {
        var which;
        which = model.get('is_active') ? 'active' : 'inactive';
        return (_this.$("#" + which + "-assets")).append((new AssetRowView({
          model: model
        })).render().el);
      });
      _ref = ['inactive', 'active'];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        which = _ref[_i];
        this.$("." + which + "-table thead").toggle(!!(this.$("#" + which + "-assets tr").length));
      }
      return this;
    };

    return AssetsView;

  })(Backbone.View);

  API.App = App = (function(_super) {

    __extends(App, _super);

    function App() {
      this.add = __bind(this.add, this);

      this.initialize = __bind(this.initialize, this);
      return App.__super__.constructor.apply(this, arguments);
    }

    App.prototype.initialize = function() {
      var _this = this;
      ($(window)).ajaxError(function() {
        return ($('#request-error')).html((get_template('request-error'))());
      });
      (API.assets = new Assets()).fetch();
      API.assetsView = new AssetsView({
        collection: API.assets,
        el: this.$('#assets')
      });
      return this;
    };

    App.prototype.events = {
      'click #add-asset-button': 'add'
    };

    App.prototype.add = function(e) {
      new EditAssetView();
      return false;
    };

    return App;

  })(Backbone.View);

  jQuery(function() {
    return API.app = new App({
      el: $('body')
    });
  });

}).call(this);
